#!/usr/bin/env elixir
Mix.install([:dagger])

Application.ensure_all_started(:inets)

{:ok, client} = Dagger.connect()

root_directory = __ENV__.file |> Path.dirname() |> Path.dirname() |> Path.dirname()

package = client
  |> Dagger.Client.host()
  |> Dagger.Host.directory(root_directory, exclude: ["deps", "_build"])

{:ok, _} = client 
  |> Dagger.Client.container() 
  |> Dagger.Container.from("hexpm/elixir:1.17.2-erlang-27.0.1-alpine-3.18.7")
  |> Dagger.Container.with_mounted_directory("/package", package)
  |> Dagger.Container.with_workdir("/package")
  |> Dagger.Container.with_exec(["mix", "deps.get"])
  |> Dagger.Container.with_exec(["mix", "test"])
  |> Dagger.Container.stdout()

Dagger.close(client)
